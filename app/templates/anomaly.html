{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Enhanced Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-3">
        Anomaly Detection Dashboard
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Monitor and analyze your transactions for unusual patterns with our
        advanced detection system
      </p>
    </div>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
      <!-- Enhanced Transaction Form -->
      <div
        class="bg-white shadow-xl rounded-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300"
      >
        <div class="bg-blue-600 px-6 py-4">
          <h2 class="text-xl font-semibold text-white">New Transaction</h2>
        </div>
        <div class="p-6">
          <form id="transactionForm" class="space-y-5">
            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-2"
                for="amount"
              >
                Amount
              </label>
              <div class="relative">
                <span
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500"
                  >$</span
                >
                <input
                  class="pl-8 shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full text-sm border-gray-300 rounded-lg transition-colors duration-200"
                  id="amount"
                  type="number"
                  step="0.01"
                  required
                  placeholder="Enter amount"
                />
              </div>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-2"
                for="category"
              >
                Category
              </label>
              <select
                class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full text-sm border-gray-300 rounded-lg transition-colors duration-200"
                id="category"
                required
              >
                <option value="">Select category</option>
                <option value="food">Food</option>
                <option value="transport">Transport</option>
                <option value="entertainment">Entertainment</option>
                <option value="bills">Bills</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-2"
                for="description"
              >
                Description
              </label>
              <input
                class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full text-sm border-gray-300 rounded-lg transition-colors duration-200"
                id="description"
                type="text"
                required
                placeholder="Enter description"
              />
            </div>

            <div>
              <label
                class="block text-sm font-medium text-gray-700 mb-2"
                for="date"
              >
                Date
              </label>
              <input
                class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full text-sm border-gray-300 rounded-lg transition-colors duration-200"
                id="date"
                type="date"
                required
              />
            </div>

            <div class="pt-4">
              <button
                type="submit"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transform hover:scale-[1.02] transition-all duration-200"
              >
                Check Transaction
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Enhanced Detection Result -->
      <div
        id="result"
        class="hidden bg-white shadow-xl rounded-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300"
      >
        <div class="bg-blue-600 px-6 py-4">
          <h2 class="text-xl font-semibold text-white">Detection Result</h2>
        </div>
        <div class="p-6">
          <div id="resultContent"></div>
        </div>
      </div>
    </div>

    <!-- Enhanced Transaction History -->
    <div
      class="mt-12 bg-white shadow-xl rounded-xl overflow-hidden transform hover:scale-[1.01] transition-transform duration-300"
    >
      <div class="bg-blue-600 px-6 py-4">
        <h2 class="text-xl font-semibold text-white">Transaction History</h2>
      </div>
      <div class="p-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Date
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Amount
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Category
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Description
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Status
                </th>
              </tr>
            </thead>
            <tbody
              id="historyContent"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Transaction history will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block scripts %}
<script>
  function formatCurrency(amount) {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    }).format(amount);
  }

  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function showLoading(element) {
    element.classList.add("opacity-50", "cursor-wait");
    element.disabled = true;
  }

  function hideLoading(element) {
    element.classList.remove("opacity-50", "cursor-wait");
    element.disabled = false;
  }

  document
    .getElementById("transactionForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitButton = e.target.querySelector('button[type="submit"]');
      showLoading(submitButton);

      try {
        const user_id = localStorage.getItem("user_id");
        if (!user_id) {
          alert("Please login first");
          window.location.href = "/auth/login-page";
          return;
        }

        const amount = parseFloat(document.getElementById("amount").value);
        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid amount greater than 0");
          return;
        }

        const transaction = {
          amount: amount,
          category: document.getElementById("category").value,
          description: document.getElementById("description").value.trim(),
          date: document.getElementById("date").value,
          user_id: user_id,
        };

        if (!transaction.description) {
          alert("Please enter a description");
          return;
        }

        if (!transaction.date) {
          alert("Please select a date");
          return;
        }

        const response = await fetch("/api/anomaly/detect", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(transaction),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Error processing transaction");
        }

        const result = await response.json();

        const resultDiv = document.getElementById("result");
        const resultContent = document.getElementById("resultContent");
        resultDiv.classList.remove("hidden");

        resultContent.innerHTML = `
        <div class="${
          result.analysis.is_anomaly
            ? "bg-red-50 border-red-400"
            : "bg-green-50 border-green-400"
        } border-l-4 p-6 rounded-lg">
          <div class="flex items-center mb-4">
            <div class="${
              result.analysis.is_anomaly ? "text-red-800" : "text-green-800"
            } font-semibold text-xl">
              ${
                result.analysis.is_anomaly
                  ? "Anomaly Detected!"
                  : "Normal Transaction"
              }
            </div>
          </div>
          <div class="space-y-3 text-base">
            <p class="text-gray-700 flex items-center">
              <span class="font-medium mr-2">Confidence Score:</span>
              <span class="px-3 py-1 rounded-full ${
                result.analysis.is_anomaly ? "bg-red-100" : "bg-green-100"
              }">
                ${(result.analysis.confidence_score * 100).toFixed(2)}%
              </span>
            </p>
            <p class="text-gray-700">
              <span class="font-medium">Amount Analysis:</span><br>
              <span class="text-sm">${
                result.analysis.insights.amount_analysis
              }</span>
            </p>
            <p class="text-gray-700">
              <span class="font-medium">Timing:</span><br>
              <span class="text-sm">${
                result.analysis.insights.timing_analysis
              }</span>
            </p>
            <p class="text-gray-700">
              <span class="font-medium">Category:</span><br>
              <span class="text-sm">${
                result.analysis.insights.category_frequency
              }</span>
            </p>
          </div>
        </div>
      `;

        await loadHistory();
        document.getElementById("transactionForm").reset();
      } catch (error) {
        console.error("Error:", error);
        alert(error.message || "Error processing transaction");
      } finally {
        hideLoading(submitButton);
      }
    });

  async function loadHistory() {
    try {
      const user_id = localStorage.getItem("user_id");
      if (!user_id) return;

      const response = await fetch(`/api/anomaly/history/${user_id}`);
      if (!response.ok) {
        throw new Error("Failed to load history");
      }

      const data = await response.json();
      const historyContent = document.getElementById("historyContent");

      historyContent.innerHTML = data
        .map(
          (transaction) => `
        <tr class="hover:bg-gray-50 transition-colors duration-150">
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${formatDate(transaction.date)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
            ${formatCurrency(transaction.amount)}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
            ${transaction.category}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            ${transaction.description}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="${
              transaction.anomaly_results[0]?.is_anomaly
                ? "bg-red-100 text-red-800"
                : "bg-green-100 text-green-800"
            } px-3 py-1 rounded-full text-xs font-medium">
              ${
                transaction.anomaly_results[0]?.is_anomaly
                  ? "Anomaly"
                  : "Normal"
              }
            </span>
          </td>
        </tr>
      `
        )
        .join("");
    } catch (error) {
      console.error("Error loading history:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadHistory);
</script>
{% endblock %}
