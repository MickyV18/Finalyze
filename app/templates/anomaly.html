{% block content %}
<div class="min-h-screen">
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>Dasbor Arus Kas</h1>
      <p>
        Pantau dan analisis transaksi Anda untuk menemukan pola yang tidak biasa
        dengan sistem deteksi canggih kami
      </p>
    </div>

    <div class="grid-container">
      <!-- Transaction Form -->
      <div class="card">
        <div class="card-header">
          <h2>Transaksi Baru</h2>
        </div>
        <div class="card-body">
          <form id="transactionForm">
            <div class="form-group">
              <label for="amount">Jumlah</label>
              <div class="input-group">
                <span class="currency-symbol">Rp</span>
                <input
                  id="amount"
                  type="number"
                  step="100"
                  required
                  placeholder="Masukkan Biaya"
                />
              </div>
            </div>

            <div class="form-group">
              <label for="category">Kategori</label>
              <select id="category" required>
                <option value="">Pilih Kategori</option>
                <option value="food">Makanan</option>
                <option value="transport">Transportasi</option>
                <option value="entertainment">Hiburan</option>
                <option value="bills">Tagihan</option>
                <option value="other">Lainnya</option>
              </select>
            </div>

            <div class="form-group">
              <label for="description">Deskripsi</label>
              <input
                id="description"
                type="text"
                required
                placeholder="Masukkan Deskripsi"
              />
            </div>

            <div class="form-group">
              <label for="date">Tanggal</label>
              <input id="date" type="date" required />
            </div>

            <button type="submit" class="btn btn-primary">
              Kirim Transaksi
            </button>
          </form>
        </div>
      </div>

      <!-- Detection Result -->
      <div id="result" class="card hidden">
        <div class="card-header">
          <h2>Hasil Deteksi</h2>
        </div>
        <div class="card-body">
          <div id="resultContent"></div>
        </div>
      </div>
    </div>

    <!-- Transaction History -->
    <div class="card mt-20">
      <div class="card-header">
        <h2>Histori Transaksi</h2>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table>
            <thead>
              <tr>
                <th>Tanggal</th>
                <th>Jumlah</th>
                <th>Kategori</th>
                <th>Deskripsi</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="historyContent"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .min-h-screen {
    min-height: 100vh;
    background-color: #f5f5f5;
    padding: 2rem 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .header h1 {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 1rem;
  }

  .header p {
    color: #666;
    font-size: 1.1rem;
  }

  .grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 768px) {
    .grid-container {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .card-header {
    background: #4a90e2;
    color: white;
    padding: 1rem 1.5rem;
  }

  .card-header h2 {
    margin: 0;
    font-size: 1.25rem;
  }

  .card-body {
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: #333;
    font-weight: 500;
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
  }

  .input-group {
    position: relative;
  }

  .currency-symbol {
    position: absolute;
    left: 0.4rem;
    top: 50%;
    transform: translateY(-50%);
    color: #666;
  }

  .input-group input {
    padding-left: 1.75rem;
  }

  .btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .btn-primary {
    background: #4a90e2;
    color: white;
    width: 100%;
  }

  .btn-primary:hover {
    background: #357abd;
  }

  .hidden {
    display: none;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th,
  td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    background: #f8f9fa;
    font-weight: 600;
    color: #333;
  }

  .table-responsive {
    overflow-x: auto;
  }

  .mt-20 {
    margin-top: 2rem;
  }

  /* Status badges */
  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .status-normal {
    background: #d1fae5;
    color: #065f46;
  }

  .status-anomaly {
    background: #fee2e2;
    color: #991b1b;
  }
</style>

{% endblock %} {% block scripts %}
<script>
  function formatCurrency(amount) {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
    }).format(amount);
  }

  function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function showLoading(element) {
    element.classList.add("opacity-50", "cursor-wait");
    element.disabled = true;
  }

  function hideLoading(element) {
    element.classList.remove("opacity-50", "cursor-wait");
    element.disabled = false;
  }

  document
    .getElementById("transactionForm")
    .addEventListener("submit", async (e) => {
      e.preventDefault();

      const submitButton = e.target.querySelector('button[type="submit"]');
      showLoading(submitButton);

      try {
        const user_id = localStorage.getItem("user_id");
        if (!user_id) {
          alert("Please login first");
          window.location.href = "/auth/login-page";
          return;
        }

        const amount = parseFloat(document.getElementById("amount").value);
        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid amount greater than 0");
          return;
        }

        const transaction = {
          amount: amount,
          category: document.getElementById("category").value,
          description: document.getElementById("description").value.trim(),
          date: document.getElementById("date").value,
          user_id: user_id,
        };

        if (!transaction.description) {
          alert("Please enter a description");
          return;
        }

        if (!transaction.date) {
          alert("Please select a date");
          return;
        }

        const response = await fetch("/api/anomaly/detect", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(transaction),
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Error processing transaction");
        }

        const result = await response.json();

        const resultDiv = document.getElementById("result");
        const resultContent = document.getElementById("resultContent");
        resultDiv.classList.remove("hidden");

        resultContent.innerHTML = `
        <div class="${
          result.analysis.is_anomaly ? "status-anomaly" : "status-normal"
        } p-6 rounded">
          <div class="result-header">
            <div class="result-title">
              ${
                result.analysis.is_anomaly
                  ? "Anomaly Detected!"
                  : "Normal Transaction"
              }
            </div>
          </div>
          <div class="result-details">
            <p class="confidence-score">
              <span class="label">Confidence Score:</span>
              <span class="value">${(
                result.analysis.confidence_score * 100
              ).toFixed(2)}%</span>
            </p>
            <p class="analysis-item">
              <span class="label">Amount Analysis:</span>
              <span class="value">${
                result.analysis.insights.amount_analysis
              }</span>
            </p>
            <p class="analysis-item">
              <span class="label">Timing:</span>
              <span class="value">${
                result.analysis.insights.timing_analysis
              }</span>
            </p>
            <p class="analysis-item">
              <span class="label">Category:</span>
              <span class="value">${
                result.analysis.insights.category_frequency
              }</span>
            </p>
          </div>
        </div>
      `;

        await loadHistory();
        document.getElementById("transactionForm").reset();
      } catch (error) {
        console.error("Error:", error);
        alert(error.message || "Error processing transaction");
      } finally {
        hideLoading(submitButton);
      }
    });

  async function loadHistory() {
    try {
      const user_id = localStorage.getItem("user_id");
      if (!user_id) return;

      const response = await fetch(`/api/anomaly/history/${user_id}`);
      if (!response.ok) {
        throw new Error("Failed to load history");
      }

      const data = await response.json();
      const historyContent = document.getElementById("historyContent");

      historyContent.innerHTML = data
        .map(
          (transaction) => `
        <tr>
          <td>${formatDate(transaction.date)}</td>
          <td>${formatCurrency(transaction.amount)}</td>
          <td class="capitalize">${transaction.category}</td>
          <td>${transaction.description}</td>
          <td>
            <span class="status-badge ${
              transaction.anomaly_results[0]?.is_anomaly
                ? "status-anomaly"
                : "status-normal"
            }">
              ${
                transaction.anomaly_results[0]?.is_anomaly
                  ? "Anomaly"
                  : "Normal"
              }
            </span>
          </td>
        </tr>
      `
        )
        .join("");
    } catch (error) {
      console.error("Error loading history:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadHistory);
</script>
{% endblock %}
